<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary-color: #10a37f;
            --primary-dark: #0d8a6a;
            --bg-color: #ffffff;
            --sidebar-bg: #f7f7f8;
            --chat-bg: #ffffff;
            --text-primary: #202123;
            --text-secondary: #565869;
            --border-color: #e5e5e7;
            --message-user-bg: #f7f7f8;
            --message-ai-bg: #ffffff;
            --shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary-color: #10a37f;
            --primary-dark: #0d8a6a;
            --bg-color: #343541;
            --sidebar-bg: #202123;
            --chat-bg: #343541;
            --text-primary: #ececf1;
            --text-secondary: #acacbe;
            --border-color: #4d4d4f;
            --message-user-bg: #444654;
            --message-ai-bg: #444654;
            --shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 10;
        }

        .new-chat-btn {
            margin: 10px;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .new-chat-btn:hover {
            background-color: var(--primary-dark);
        }

        .conversations {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .conversation-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .conversation-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .conversation-item.active {
            background-color: rgba(16, 163, 127, 0.1);
            color: var(--primary-color);
        }

        .conversation-item i {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .conversation-item:hover i {
            opacity: 0.7;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        .theme-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        body.dark-mode .theme-toggle-container {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .theme-toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .theme-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .theme-slider {
            background-color: var(--primary-color);
        }

        input:checked + .theme-slider:before {
            transform: translateX(26px);
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: rgba(16, 163, 127, 0.1);
            color: var(--primary-color);
            font-size: 13px;
            margin-bottom: 15px;
        }

        .api-status i {
            font-size: 14px;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .user-message .message-avatar {
            background-color: #5436da;
            color: white;
        }

        .ai-message .message-avatar {
            background-color: var(--primary-color);
            color: white;
        }

        .message-content {
            flex: 1;
            padding-top: 5px;
        }

        .user-message .message-content {
            background-color: var(--message-user-bg);
            padding: 15px;
            border-radius: 10px;
            line-height: 1.5;
        }

        .ai-message .message-content {
            background-color: var(--message-ai-bg);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            line-height: 1.5;
        }

        .message-content pre {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 12px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        body.dark-mode .message-content pre {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .message-content code {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        body.dark-mode .message-content code {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--chat-bg);
        }

        .input-area {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            resize: none;
            max-height: 200px;
            background-color: var(--chat-bg);
            color: var(--text-primary);
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
        }

        .send-btn {
            position: absolute;
            right: 10px;
            bottom: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background-color: var(--primary-dark);
        }

        .send-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        .input-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
            text-align: center;
        }

        /* Loading indicator */
        .loading {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-top: 10px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--primary-color);
            animation: loading 1.4s ease-in-out infinite;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Thinking indicator */
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            padding: 8px 0;
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--primary-color);
            animation: thinking 1.5s infinite ease-in-out;
        }

        .thinking-dots span:nth-child(1) { animation-delay: -0.3s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.15s; }

        @keyframes thinking {
            0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
            30% { opacity: 1; transform: scale(1); }
        }

        /* Continue button */
        .continue-container {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .continue-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .continue-btn:hover {
            background-color: var(--primary-dark);
        }

        .continue-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            margin: auto;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--border-color);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                height: 100%;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .menu-toggle {
                display: block;
            }

            .message {
                max-width: 100%;
            }

            .chat-container {
                padding: 15px;
            }
        }

        .hidden {
            display: none;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .model-info {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 4px 8px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        body.dark-mode .model-info {
            background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <button class="new-chat-btn" id="newChatBtn">
                <i class="fas fa-plus"></i>
                New chat
            </button>

            <div class="conversations" id="conversationsList">
                <!-- Conversations will be added here dynamically -->
                <div class="conversation-item active" data-id="convo1">
                    <span>Welcome Chat</span>
                    <i class="fas fa-trash"></i>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="theme-toggle-container">
                    <div class="theme-toggle-label">
                        <i class="fas fa-moon"></i>
                        <span>Dark mode</span>
                    </div>
                    <label class="theme-toggle">
                        <input type="checkbox" id="themeToggle">
                        <span class="theme-slider"></span>
                    </label>
                </div>

                <div class="api-status">
                    <i class="fas fa-key"></i>
                    <span>API Key: Ready</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="chat-header">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="chat-title" id="chatTitle">Welcome Chat</div>
                <div class="header-actions">
                    <div class="model-info">DeepSeek AI</div>
                </div>
            </header>

            <div class="chat-container" id="chatContainer">
                <!-- Chat messages will be added here dynamically -->
                <div class="empty-state" id="emptyState">
                    <i class="fas fa-robot"></i>
                    <h3>How can I help you today?</h3>
                    <p>Start typing to begin a conversation with DeepSeek AI</p>
                </div>

                <!-- Example welcome message -->
                <div class="message ai-message" id="welcomeMessage">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <p>Hello! I'm DeepSeek AI, an AI assistant created by DeepSeek Company. I'm here to help you with various tasks like answering questions, writing code, analyzing documents, and much more.</p>
                        <p>You can ask me anything - from technical programming questions to creative writing help. What would you like to explore today?</p>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-area">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Message DeepSeek..." 
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="input-info">
                    DeepSeek can make mistakes. Consider checking important information.
                </div>
            </div>
        </main>
    </div>

    <script>
        // Decoded API key
        const apiKey = "sk-b6d0e97e7831455cbb4f45ebcf4d5e1e";
        
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menuToggle');
        const newChatBtn = document.getElementById('newChatBtn');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatContainer = document.getElementById('chatContainer');
        const emptyState = document.getElementById('emptyState');
        const conversationsList = document.getElementById('conversationsList');
        const themeToggle = document.getElementById('themeToggle');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const chatTitle = document.getElementById('chatTitle');

        // State variables
        let currentConversationId = 'convo1';
        let currentAiMessageId = null;
        let isStreaming = false;
        let continueResponseController = null;
        
        let conversations = [
            {
                id: 'convo1',
                title: 'Welcome Chat',
                messages: [
                    { role: 'ai', content: "Hello! I'm DeepSeek AI, an AI assistant created by DeepSeek Company. I'm here to help you with various tasks like answering questions, writing code, analyzing documents, and much more.\n\nYou can ask me anything - from technical programming questions to creative writing help. What would you like to explore today?" }
                ]
            }
        ];

        // Initialize the app
        function initApp() {
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('deepseek-theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.checked = true;
            }

            // Load conversations
            renderConversations();
            loadConversation(currentConversationId);

            // Event Listeners
            menuToggle.addEventListener('click', toggleSidebar);
            newChatBtn.addEventListener('click', createNewChat);
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keydown', handleInputKeydown);
            chatInput.addEventListener('input', autoResizeTextarea);
            themeToggle.addEventListener('change', toggleTheme);
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    !menuToggle.contains(e.target) &&
                    sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                }
            });

            // Load example conversation items click events
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('fa-trash')) {
                        const conversationId = item.dataset.id || 'convo1';
                        loadConversation(conversationId);
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('open');
                        }
                    }
                });
                
                // Add delete functionality
                const deleteBtn = item.querySelector('.fa-trash');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const conversationId = item.dataset.id;
                        deleteConversation(conversationId);
                    });
                }
            });
        }

        // Toggle sidebar on mobile
        function toggleSidebar() {
            sidebar.classList.toggle('open');
        }

        // Toggle dark/light theme
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('deepseek-theme', isDarkMode ? 'dark' : 'light');
        }

        // Create a new chat
        function createNewChat() {
            const newId = 'convo' + Date.now();
            const newConversation = {
                id: newId,
                title: 'New Chat',
                messages: []
            };
            
            conversations.push(newConversation);
            renderConversations();
            loadConversation(newId);
            
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }
        }

        // Delete a conversation
        function deleteConversation(conversationId) {
            if (conversations.length <= 1) {
                alert('You must have at least one conversation');
                return;
            }
            
            conversations = conversations.filter(conv => conv.id !== conversationId);
            renderConversations();
            
            if (currentConversationId === conversationId) {
                // Load the first available conversation
                currentConversationId = conversations[0].id;
                loadConversation(currentConversationId);
            }
        }

        // Render conversations list
        function renderConversations() {
            conversationsList.innerHTML = '';
            
            conversations.forEach(conv => {
                const isActive = conv.id === currentConversationId;
                const conversationElement = document.createElement('div');
                conversationElement.className = `conversation-item ${isActive ? 'active' : ''}`;
                conversationElement.dataset.id = conv.id;
                conversationElement.innerHTML = `
                    <span>${conv.title}</span>
                    <i class="fas fa-trash"></i>
                `;
                
                conversationElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('fa-trash')) {
                        loadConversation(conv.id);
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('open');
                        }
                    }
                });
                
                const deleteBtn = conversationElement.querySelector('.fa-trash');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteConversation(conv.id);
                });
                
                conversationsList.appendChild(conversationElement);
            });
        }

        // Load conversation into chat
        function loadConversation(conversationId) {
            currentConversationId = conversationId;
            const conversation = conversations.find(conv => conv.id === conversationId);
            
            if (!conversation) return;
            
            // Update UI
            chatTitle.textContent = conversation.title;
            renderConversations();
            
            // Clear chat container
            chatContainer.innerHTML = '';
            
            // Show or hide empty state
            if (conversation.messages.length === 0) {
                emptyState.classList.remove('hidden');
                chatContainer.appendChild(emptyState);
            } else {
                emptyState.classList.add('hidden');
                
                // Render messages
                conversation.messages.forEach(message => {
                    addMessageToChat(message.role, message.content, false);
                });
                
                // Scroll to bottom
                scrollToBottom();
            }
        }

        // Handle sending message
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat('user', message, true);
            
            // Clear input
            chatInput.value = '';
            autoResizeTextarea();
            chatInput.focus();
            
            // Disable send button while waiting for response
            sendBtn.disabled = true;
            
            // Add thinking indicator
            const thinkingId = addThinkingIndicator();
            
            try {
                // Call DeepSeek API with streaming
                await callDeepSeekAPIStreaming(message);
                
                // Remove thinking indicator
                removeThinkingIndicator(thinkingId);
                
            } catch (error) {
                // Remove thinking indicator
                removeThinkingIndicator(thinkingId);
                
                // Show error message
                addMessageToChat('ai', `Error: ${error.message}`, true);
                saveMessageToConversation('ai', `Error: ${error.message}`);
                
                // Re-enable send button
                sendBtn.disabled = false;
            }
        }

        // Call DeepSeek API with streaming
        async function callDeepSeekAPIStreaming(message) {
            const url = 'https://api.deepseek.com/chat/completions';
            
            // Get conversation history for context
            const conversation = conversations.find(conv => conv.id === currentConversationId);
            const messages = conversation.messages.slice(-10); // Increased context window
            
            // Prepare messages for API
            const apiMessages = [
                { role: 'system', content: 'You are DeepSeek AI, a helpful AI assistant created by DeepSeek Company. Provide detailed, comprehensive responses.' }
            ];
            
            // Add conversation history
            messages.forEach(msg => {
                apiMessages.push({
                    role: msg.role === 'ai' ? 'assistant' : 'user',
                    content: msg.content
                });
            });
            
            // Add current user message
            apiMessages.push({ role: 'user', content: message });
            
            // Save user message
            saveMessageToConversation('user', message);
            
            // Create a new AI message element
            currentAiMessageId = 'ai-' + Date.now();
            const messageElement = createAiMessageElement();
            chatContainer.appendChild(messageElement);
            
            // Scroll to show new message
            scrollToBottom();
            
            // Start streaming response
            isStreaming = true;
            let fullResponse = '';
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: apiMessages,
                        max_tokens: 4000, // Increased token limit
                        temperature: 0.7,
                        stream: true
                    })
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Invalid API key. Please check your API key and try again.');
                    } else if (response.status === 429) {
                        throw new Error('Rate limit exceeded. Please try again later.');
                    } else {
                        throw new Error(`API error: ${response.status}`);
                    }
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (isStreaming) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                isStreaming = false;
                                break;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.choices && parsed.choices[0].delta.content) {
                                    const content = parsed.choices[0].delta.content;
                                    fullResponse += content;
                                    updateAiMessage(fullResponse);
                                    scrollToBottom();
                                }
                            } catch (e) {
                                // Skip parsing errors
                            }
                        }
                    }
                }
                
                reader.releaseLock();
                
                // Save the complete response
                saveMessageToConversation('ai', fullResponse);
                
                // Check if response seems truncated and add continue button
                if (fullResponse.length > 3000 && !fullResponse.endsWith('.') && !fullResponse.endsWith('!') && !fullResponse.endsWith('?')) {
                    addContinueButton(fullResponse);
                }
                
                // Re-enable send button
                sendBtn.disabled = false;
                currentAiMessageId = null;
                
            } catch (error) {
                isStreaming = false;
                currentAiMessageId = null;
                throw error;
            }
        }

        // Continue a response
        async function continueResponse() {
            const conversation = conversations.find(conv => conv.id === currentConversationId);
            if (!conversation || conversation.messages.length === 0) return;
            
            // Get the last AI message
            const lastAiMessage = [...conversation.messages].reverse().find(msg => msg.role === 'ai');
            if (!lastAiMessage) return;
            
            // Disable continue button
            const continueBtn = document.querySelector('.continue-btn');
            if (continueBtn) continueBtn.disabled = true;
            
            // Add thinking indicator
            const thinkingId = addThinkingIndicator();
            
            try {
                const url = 'https://api.deepseek.com/chat/completions';
                const apiMessages = [
                    { role: 'system', content: 'You are DeepSeek AI. Continue your previous response naturally.' },
                    { role: 'user', content: 'Please continue your previous response.' },
                    { role: 'assistant', content: lastAiMessage.content }
                ];
                
                // Create a new AI message element for continuation
                currentAiMessageId = 'ai-continue-' + Date.now();
                const messageElement = createAiMessageElement();
                chatContainer.appendChild(messageElement);
                scrollToBottom();
                
                // Remove continue button
                const continueContainer = document.querySelector('.continue-container');
                if (continueContainer) continueContainer.remove();
                
                isStreaming = true;
                let continuationResponse = '';
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: apiMessages,
                        max_tokens: 4000,
                        temperature: 0.7,
                        stream: true
                    })
                });
                
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (isStreaming) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                isStreaming = false;
                                break;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.choices && parsed.choices[0].delta.content) {
                                    const content = parsed.choices[0].delta.content;
                                    continuationResponse += content;
                                    updateAiMessage(continuationResponse);
                                    scrollToBottom();
                                }
                            } catch (e) {
                                // Skip parsing errors
                            }
                        }
                    }
                }
                
                reader.releaseLock();
                
                // Save continuation as new message
                saveMessageToConversation('ai', continuationResponse);
                
                // Check if continuation seems truncated
                if (continuationResponse.length > 3000 && !continuationResponse.endsWith('.') && !continuationResponse.endsWith('!') && !continuationResponse.endsWith('?')) {
                    addContinueButton(continuationResponse);
                }
                
                // Remove thinking indicator
                removeThinkingIndicator(thinkingId);
                
                currentAiMessageId = null;
                
            } catch (error) {
                removeThinkingIndicator(thinkingId);
                isStreaming = false;
                currentAiMessageId = null;
                addMessageToChat('ai', `Error continuing: ${error.message}`, true);
            }
        }

        // Create AI message element for streaming
        function createAiMessageElement() {
            const messageElement = document.createElement('div');
            messageElement.className = 'message ai-message';
            messageElement.id = currentAiMessageId;
            
            messageElement.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <p></p>
                </div>
            `;
            
            return messageElement;
        }

        // Update streaming AI message
        function updateAiMessage(content) {
            const messageElement = document.getElementById(currentAiMessageId);
            if (messageElement) {
                const contentElement = messageElement.querySelector('.message-content p');
                contentElement.innerHTML = formatMessage(content);
            }
        }

        // Add continue button
        function addContinueButton() {
            const continueContainer = document.createElement('div');
            continueContainer.className = 'continue-container';
            continueContainer.innerHTML = `
                <button class="continue-btn" onclick="continueResponse()">
                    <i class="fas fa-arrow-down"></i>
                    Continue
                </button>
            `;
            chatContainer.appendChild(continueContainer);
            scrollToBottom();
        }

        // Add message to chat UI
        function addMessageToChat(role, content, scroll = true) {
            // Hide empty state if it's visible
            emptyState.classList.add('hidden');
            
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.className = `message ${role}-message`;
            
            const avatarIcon = role === 'user' ? 'fas fa-user' : 'fas fa-robot';
            const avatarBg = role === 'user' ? '#5436da' : '#10a37f';
            
            messageElement.innerHTML = `
                <div class="message-avatar" style="background-color: ${avatarBg}">
                    <i class="${avatarIcon}"></i>
                </div>
                <div class="message-content">
                    <p>${formatMessage(content)}</p>
                </div>
            `;
            
            chatContainer.appendChild(messageElement);
            
            if (scroll) {
                scrollToBottom();
            }
            
            // Re-enable send button
            sendBtn.disabled = false;
        }

        // Add thinking indicator
        function addThinkingIndicator() {
            const thinkingElement = document.createElement('div');
            thinkingElement.className = 'message ai-message';
            thinkingElement.id = 'thinking-' + Date.now();
            
            thinkingElement.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="thinking-indicator">
                        <span>DeepSeek is thinking</span>
                        <div class="thinking-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(thinkingElement);
            scrollToBottom();
            
            return thinkingElement.id;
        }

        // Remove thinking indicator
        function removeThinkingIndicator(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        }

        // Format message content (simple markdown support)
        function formatMessage(content) {
            if (!content) return '';
            
            // Convert line breaks to <br>
            let formatted = content.replace(/\n/g, '<br>');
            
            // Convert inline code (backticks)
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Convert code blocks (triple backticks)
            formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            
            return formatted;
        }

        // Save message to current conversation
        function saveMessageToConversation(role, content) {
            const conversation = conversations.find(conv => conv.id === currentConversationId);
            if (conversation) {
                conversation.messages.push({ role, content });
                
                // Update conversation title if it's the first user message
                if (conversation.messages.length === 1 && role === 'user') {
                    conversation.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                    renderConversations();
                    chatTitle.textContent = conversation.title;
                }
            }
        }

        // Scroll chat to bottom
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Handle Enter key for sending message
        function handleInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // Auto-resize textarea
        function autoResizeTextarea() {
            chatInput.style.height = 'auto';
            chatInput.style.height = (chatInput.scrollHeight) + 'px';
        }

        // Make continueResponse available globally
        window.continueResponse = continueResponse;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
